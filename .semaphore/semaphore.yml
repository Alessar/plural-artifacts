version: v1.0
name: plural-cli
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
- name: build
  skip:
    when: "branch != 'main'"
  task:
    secrets:
    - name: GCP
    - name: gcp-test
    - name: forge
    - name: plural
    prologue:
      commands:
      # Authenticate using the file injected from the secret
      - gcloud auth activate-service-account --key-file=.secrets/gcp-piazzaapp.json
      # Don't forget -q to silence confirmation prompts
      - gcloud auth configure-docker -q
      # - docker login -u mjg@plural.sh -p $PLURAL_ACCESS_TOKEN dkr.plural.sh
      - checkout
    jobs:
    - name: "Build airflow"
      commands:
      - docker pull apache/airflow:2.0.1-python3.8
      - docker tag apache/airflow:2.0.1-python3.8 dkr.plural.sh/airflow/airflow:2.0.1-python3.8
      - docker push dkr.plural.sh/airflow/airflow:2.0.1-python3.8
    - name: "build postgres exporter"
      commands:
      - docker pull bitnami/postgres-exporter:0.8.0-debian-10-r354
      - docker tag bitnami/postgres-exporter:0.8.0-debian-10-r354 gcr.io/piazzaapp/postgres-exporter:0.8.0
      - docker push gcr.io/piazzaapp/postgres-exporter:0.8.0
    - name: "build postgres"
      commands:
      - docker pull bitnami/postgresql:11.7.0-debian-10-r9
      - docker tag bitnami/postgresql:11.7.0-debian-10-r9 gcr.io/piazzaapp/postgres:11.7.0-debian-10-r9
      - docker push gcr.io/piazzaapp/postgres:11.7.0-debian-10-r9
    - name: "build rabbitmq"
      commands:
      - docker pull rabbitmq:3.8.16-management
      - docker tag rabbitmq:3.8.16-management gcr.io/piazzaapp/rabbitmq:3.8.16-management
      - docker push gcr.io/piazzaapp/rabbitmq:3.8.16-management
    - name: "build influxdb"
      commands:
      - docker pull influxdb:1.8.0-alpine
      - docker tag influxdb:1.8.0-alpine gcr.io/piazzaapp/influxdb:1.8.0-alpine
      - docker push gcr.io/piazzaapp/influxdb:1.8.0-alpine
    - name: "build busybox"
      commands:
      - docker pull busybox:latest
      - docker tag busybox:latest gcr.io/piazzaapp/busybox:latest
      - docker push gcr.io/piazzaapp/busybox:latest
    - name: "build redis"
      commands:
      - docker pull bitnami/redis:6.0.9-debian-10-r0
      - docker tag bitnami/redis:6.0.9-debian-10-r0 gcr.io/piazzaapp/bitnami/redis:6.0.9-debian-10-r0
      - docker push gcr.io/piazzaapp/bitnami/redis:6.0.9-debian-10-r0
    - name: "build redis exporter"
      commands:
      - docker pull bitnami/redis-exporter:1.12.1-debian-10-r11
      - docker tag bitnami/redis-exporter:1.12.1-debian-10-r11 gcr.io/piazzaapp/bitnami/redis-exporter:1.12.1-debian-10-r11
      - docker push gcr.io/piazzaapp/bitnami/redis-exporter:1.12.1-debian-10-r11
    - name: "build promtail"
      commands:
      - docker pull grafana/promtail:1.6.0
      - docker tag grafana/promtail:1.6.0 gcr.io/piazzaapp/grafana/promtail:1.6.0
      - docker push gcr.io/piazzaapp/grafana/promtail:1.6.0
    - name: "build kubed"
      commands:
      - docker pull appscode/kubed:v0.13.0-beta.0
      - docker tag appscode/kubed:v0.13.0-beta.0 gcr.io/piazzaapp/appscode/kubed:v0.13.0-beta.0
      - docker push gcr.io/piazzaapp/appscode/kubed:v0.13.0-beta.0
    - name: "build loki"
      commands:
      - docker pull grafana/loki:1.6.0
      - docker tag grafana/loki:1.6.0 gcr.io/piazzaapp/grafana/loki:1.6.0
      - docker push gcr.io/piazzaapp/grafana/loki:1.6.0
    - name: "build certgen"
      commands:
      - docker pull jettech/kube-webhook-certgen:v1.5.0
      - docker tag jettech/kube-webhook-certgen:v1.5.0 gcr.io/piazzaapp/jettech/kube-webhook-certgen:v1.5.0
      - docker push gcr.io/piazzaapp/jettech/kube-webhook-certgen:v1.5.0
    - name: "build statsd-exporter"
      commands:
      - docker pull prom/statsd-exporter:v0.20.2
      - docker tag prom/statsd-exporter:v0.20.2 gcr.io/piazzaapp/prom/statsd-exporter:v0.20.2
      - docker push gcr.io/piazzaapp/prom/statsd-exporter:v0.20.2
    - name: "build curl"
      commands:
      - docker pull curlimages/curl:7.73.0
      - docker tag curlimages/curl:7.73.0 gcr.io/piazzaapp/curlimages/curl:7.73.0
      - docker push gcr.io/piazzaapp/curlimages/curl:7.73.0
    - name: "build grafana"
      commands:
      - docker pull grafana/grafana:7.4.5
      - docker tag grafana/grafana:7.4.5 gcr.io/piazzaapp/grafana/grafana:7.4.5
      - docker push gcr.io/piazzaapp/grafana/grafana:7.4.5
    - name: "build sidecar"
      commands:
      - docker pull kiwigrid/k8s-sidecar:1.1.0
      - docker tag kiwigrid/k8s-sidecar:1.1.0 gcr.io/piazzaapp/kiwigrid/k8s-sidecar:1.1.0
      - docker push gcr.io/piazzaapp/kiwigrid/k8s-sidecar:1.1.0
    - name: "build clickhouse"
      commands:
      - docker pull yandex/clickhouse-server:20.8.9.6
      - docker tag yandex/clickhouse-server:20.8.9.6 gcr.io/piazzaapp/yandex/clickhouse-server:20.8.9.6
      - docker push gcr.io/piazzaapp/yandex/clickhouse-server:20.8.9.6
    